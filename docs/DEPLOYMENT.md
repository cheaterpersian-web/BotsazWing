# Deployment Guide

## Production Deployment

### Prerequisites

- Linux server (Ubuntu 20.04+ recommended)
- Docker and Docker Compose installed
- Domain name with DNS configured
- SSL certificates (Let's Encrypt recommended)
- Minimum 4GB RAM, 2 CPU cores, 50GB storage

### Server Setup

1. **Update system**
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **Install Docker**
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   sudo usermod -aG docker $USER
   ```

3. **Install Docker Compose**
   ```bash
   sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

4. **Install Nginx (for SSL termination)**
   ```bash
   sudo apt install nginx certbot python3-certbot-nginx -y
   ```

### SSL Certificate Setup

1. **Configure Nginx for Let's Encrypt**
   ```bash
   sudo nano /etc/nginx/sites-available/telegram-bot-saas
   ```

   ```nginx
   server {
       listen 80;
       server_name yourdomain.com;
       
       location / {
           return 301 https://$server_name$request_uri;
       }
   }
   ```

2. **Enable site and get certificate**
   ```bash
   sudo ln -s /etc/nginx/sites-available/telegram-bot-saas /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   sudo certbot --nginx -d yourdomain.com
   ```

### Application Deployment

1. **Clone repository**
   ```bash
   git clone <repository-url>
   cd telegram-bot-saas
   ```

2. **Configure environment**
   ```bash
   cp .env.example .env
   nano .env
   ```

   Update the following variables:
   ```bash
   # Production settings
   DEBUG=false
   TELEGRAM_WEBHOOK_URL=https://yourdomain.com
   
   # Your bot token
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   
   # Admin Telegram IDs
   ADMIN_TELEGRAM_IDS=123456789,987654321
   
   # Payment details
   BANK_ACCOUNT_NUMBER=your_bank_account
   CRYPTO_WALLET_ADDRESS=your_crypto_wallet
   
   # Strong passwords (auto-generated by install script)
   POSTGRES_PASSWORD=strong_password_here
   SECRET_KEY=strong_secret_key_here
   ENCRYPTION_KEY=strong_encryption_key_here
   ```

3. **Update Nginx configuration**
   ```bash
   sudo nano /etc/nginx/sites-available/telegram-bot-saas
   ```

   ```nginx
   server {
       listen 443 ssl http2;
       server_name yourdomain.com;
       
       ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
       ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
       
       # Security headers
       add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
       add_header X-Frame-Options "SAMEORIGIN" always;
       add_header X-Content-Type-Options "nosniff" always;
       
       # Proxy to Docker services
       location /api/ {
           proxy_pass http://localhost:8000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       location /webhook/ {
           proxy_pass http://localhost:8080;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       location / {
           proxy_pass http://localhost:3000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

4. **Deploy application**
   ```bash
   # Run installation script
   ./install.sh
   
   # Or manually start services
   docker-compose up -d
   ```

5. **Set Telegram webhook**
   ```bash
   curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
        -H "Content-Type: application/json" \
        -d '{"url": "https://yourdomain.com/webhook/<YOUR_BOT_TOKEN>"}'
   ```

### Database Setup

1. **Initialize database**
   ```bash
   docker-compose exec postgres psql -U telegram_bot_user -d telegram_bot_saas -f /docker-entrypoint-initdb.d/init.sql
   ```

2. **Create admin user**
   ```bash
   docker-compose exec postgres psql -U telegram_bot_user -d telegram_bot_saas -c "
   INSERT INTO admins (telegram_user_id, username, first_name, last_name) 
   VALUES (123456789, 'admin', 'Admin', 'User');"
   ```

### Monitoring Setup

1. **Access Grafana**
   - URL: `https://yourdomain.com:3001`
   - Username: `admin`
   - Password: Check `.env` file

2. **Configure alerts**
   - Set up email/Slack notifications
   - Configure alert rules for critical metrics
   - Set up dashboard for monitoring

### Backup Strategy

1. **Database backups**
   ```bash
   # Create backup script
   cat > backup.sh << 'EOF'
   #!/bin/bash
   BACKUP_DIR="/backups"
   DATE=$(date +%Y%m%d_%H%M%S)
   
   mkdir -p $BACKUP_DIR
   
   # Database backup
   docker-compose exec -T postgres pg_dump -U telegram_bot_user telegram_bot_saas > $BACKUP_DIR/db_$DATE.sql
   
   # File storage backup
   docker-compose exec -T minio mc mirror /data $BACKUP_DIR/files_$DATE/
   
   # Keep only last 7 days
   find $BACKUP_DIR -name "db_*.sql" -mtime +7 -delete
   find $BACKUP_DIR -name "files_*" -mtime +7 -exec rm -rf {} \;
   EOF
   
   chmod +x backup.sh
   ```

2. **Schedule backups**
   ```bash
   # Add to crontab
   crontab -e
   
   # Daily backup at 2 AM
   0 2 * * * /path/to/backup.sh
   ```

### Security Hardening

1. **Firewall configuration**
   ```bash
   sudo ufw enable
   sudo ufw allow ssh
   sudo ufw allow 80
   sudo ufw allow 443
   sudo ufw deny 8000
   sudo ufw deny 3000
   sudo ufw deny 8080
   ```

2. **Docker security**
   ```bash
   # Create docker-compose.override.yml
   cat > docker-compose.override.yml << 'EOF'
   version: '3.8'
   services:
     postgres:
       security_opt:
         - no-new-privileges:true
       read_only: true
       tmpfs:
         - /tmp
         - /var/run/postgresql
     
     backend:
       security_opt:
         - no-new-privileges:true
       read_only: true
       tmpfs:
         - /tmp
   EOF
   ```

3. **Regular updates**
   ```bash
   # Create update script
   cat > update.sh << 'EOF'
   #!/bin/bash
   git pull origin main
   docker-compose pull
   docker-compose up -d
   docker system prune -f
   EOF
   
   chmod +x update.sh
   ```

### Scaling

#### Horizontal Scaling

1. **Load balancer setup**
   ```bash
   # Use Nginx as load balancer
   upstream backend {
       server localhost:8000;
       server localhost:8001;
       server localhost:8002;
   }
   
   upstream bot {
       server localhost:8080;
       server localhost:8081;
   }
   ```

2. **Multiple backend instances**
   ```bash
   # Scale backend services
   docker-compose up -d --scale backend=3
   docker-compose up -d --scale bot=2
   ```

#### Database Scaling

1. **Read replicas**
   ```yaml
   # Add to docker-compose.yml
   postgres-replica:
     image: postgres:15-alpine
     environment:
       POSTGRES_DB: telegram_bot_saas
       POSTGRES_USER: telegram_bot_user
       POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
     command: |
       bash -c "
       until pg_basebackup -h postgres -D /var/lib/postgresql/data -U telegram_bot_user -v -P -W; do
         echo 'Waiting for primary to connect...'
         sleep 1s
       done
       echo 'Backup done, starting replica...'
       postgres
       "
   ```

2. **Connection pooling**
   ```yaml
   # Add PgBouncer
   pgbouncer:
     image: pgbouncer/pgbouncer:latest
     environment:
       DATABASES_HOST: postgres
       DATABASES_PORT: 5432
       DATABASES_USER: telegram_bot_user
       DATABASES_PASSWORD: ${POSTGRES_PASSWORD}
       DATABASES_DBNAME: telegram_bot_saas
       POOL_MODE: transaction
       MAX_CLIENT_CONN: 100
       DEFAULT_POOL_SIZE: 20
   ```

### Performance Optimization

1. **Redis optimization**
   ```bash
   # Add to redis.conf
   maxmemory 1gb
   maxmemory-policy allkeys-lru
   save 900 1
   save 300 10
   save 60 10000
   ```

2. **PostgreSQL optimization**
   ```bash
   # Add to postgresql.conf
   shared_buffers = 256MB
   effective_cache_size = 1GB
   maintenance_work_mem = 64MB
   checkpoint_completion_target = 0.9
   wal_buffers = 16MB
   default_statistics_target = 100
   ```

3. **Nginx optimization**
   ```nginx
   # Add to nginx.conf
   worker_processes auto;
   worker_connections 1024;
   
   gzip on;
   gzip_vary on;
   gzip_min_length 1024;
   gzip_comp_level 6;
   gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
   
   client_max_body_size 50M;
   client_body_timeout 60s;
   client_header_timeout 60s;
   keepalive_timeout 65s;
   ```

### Troubleshooting

#### Common Issues

1. **Services not starting**
   ```bash
   # Check logs
   docker-compose logs -f
   
   # Check resource usage
   docker stats
   
   # Restart services
   docker-compose restart
   ```

2. **Database connection issues**
   ```bash
   # Check database status
   docker-compose exec postgres pg_isready -U telegram_bot_user
   
   # Check connections
   docker-compose exec postgres psql -U telegram_bot_user -d telegram_bot_saas -c "SELECT * FROM pg_stat_activity;"
   ```

3. **SSL certificate issues**
   ```bash
   # Renew certificate
   sudo certbot renew
   
   # Check certificate
   openssl x509 -in /etc/letsencrypt/live/yourdomain.com/cert.pem -text -noout
   ```

4. **Webhook not working**
   ```bash
   # Check webhook status
   curl "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"
   
   # Test webhook endpoint
   curl -X POST "https://yourdomain.com/webhook/<YOUR_BOT_TOKEN>" \
        -H "Content-Type: application/json" \
        -d '{"update_id": 1, "message": {"message_id": 1, "from": {"id": 123}, "chat": {"id": 123}, "date": 1640995200, "text": "test"}}'
   ```

### Maintenance

#### Regular Tasks

1. **Weekly maintenance**
   ```bash
   # Update system
   sudo apt update && sudo apt upgrade -y
   
   # Clean Docker
   docker system prune -f
   
   # Check disk space
   df -h
   
   # Check logs
   docker-compose logs --tail=100
   ```

2. **Monthly maintenance**
   ```bash
   # Update application
   git pull origin main
   docker-compose pull
   docker-compose up -d
   
   # Database maintenance
   docker-compose exec postgres psql -U telegram_bot_user -d telegram_bot_saas -c "VACUUM ANALYZE;"
   
   # Backup verification
   # Test restore from backup
   ```

3. **Security updates**
   ```bash
   # Update Docker images
   docker-compose pull
   docker-compose up -d
   
   # Update system packages
   sudo apt update && sudo apt upgrade -y
   
   # Check for vulnerabilities
   docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image <image-name>
   ```